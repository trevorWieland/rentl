# Data Schema Reference

This document describes the Pydantic models in `rentl-schemas` that define the
data flowing through the rentl pipeline. All models inherit from `BaseSchema`,
which enforces strict validation, strips whitespace from strings, and silently
drops extra fields (so LLMs can include bonus keys without breaking validation).

Source: `packages/rentl-schemas/src/rentl_schemas/`

---

## Primitive Types

These constrained types are used throughout the schema definitions.

| Type | Underlying | Pattern / Constraint | Example |
|------|-----------|----------------------|---------|
| `LineId` | `str` | `^[a-z]+(?:_[0-9]+)+$` | `scene_001_0005` |
| `SceneId` | `str` | `^[a-z]+(?:_[0-9]+)+$` | `scene_001` |
| `RouteId` | `str` | `^[a-z]+(?:_[0-9]+)+$` | `common_0` |
| `RunId` | `UUID` | UUIDv7 | `019505a2-...` |
| `PhaseRunId` | `UUID` | UUIDv7 | — |
| `ArtifactId` | `UUID` | UUIDv7 | — |
| `IssueId` | `UUID` | UUIDv7 | — |
| `NoteId` | `UUID` | UUIDv7 | — |
| `AnnotationId` | `UUID` | UUIDv7 | — |
| `RequestId` | `UUID` | UUIDv7 | — |
| `Timestamp` | `str` | ISO 8601 with timezone | `2026-02-17T12:00:00Z` |
| `LanguageCode` | `str` | `^[a-z]{2}(?:-[A-Z]{2})?$` | `ja`, `en-US` |
| `EventName` | `str` | `^[a-z][a-z0-9_]*$` | `phase_started` |
| `AnnotationType` | `str` | `^[a-z][a-z0-9_]*$` | `idiom` |

### Enums

| Enum | Values |
|------|--------|
| `PhaseName` | `ingest`, `context`, `pretranslation`, `translate`, `qa`, `edit`, `export` |
| `FileFormat` | `csv`, `jsonl`, `txt` |
| `UntranslatedPolicy` | `error`, `warn`, `allow` |
| `RunStatus` | `pending`, `running`, `completed`, `failed`, `cancelled` |
| `PhaseStatus` | `pending`, `running`, `completed`, `failed`, `skipped` |
| `QaSeverity` | `info`, `minor`, `major`, `critical` |
| `QaCategory` | `grammar`, `terminology`, `style`, `consistency`, `formatting`, `context`, `cultural`, `other` |
| `LogLevel` | `debug`, `info`, `warn`, `error` |
| `PhaseWorkStrategy` | `full`, `scene`, `chunk`, `route` |
| `ReasoningEffort` | `low`, `medium`, `high` |

---

## Core Data Models

### SourceLine

A single source-language line extracted during the **ingest** phase. This is the
fundamental input unit — one per script line.

**Module:** `rentl_schemas.io`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `line_id` | `LineId` | yes | Unique line identifier |
| `route_id` | `RouteId \| None` | no | Route identifier if available |
| `scene_id` | `SceneId \| None` | no | Scene identifier if available |
| `speaker` | `str \| None` | no | Speaker label if available |
| `text` | `str` | yes | Source text content (min 1 char) |
| `metadata` | `dict[str, JsonValue] \| None` | no | Additional structured metadata |
| `source_columns` | `list[str] \| None` | no | Original CSV column order if known |

### TranslatedLine

A translated line produced by the **translate** or **edit** phase. Same shape as
SourceLine with the addition of `source_text` for back-reference.

**Module:** `rentl_schemas.io`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `line_id` | `LineId` | yes | Unique line identifier |
| `route_id` | `RouteId \| None` | no | Route identifier if available |
| `scene_id` | `SceneId \| None` | no | Scene identifier if available |
| `speaker` | `str \| None` | no | Speaker label if available |
| `source_text` | `str \| None` | no | Original source text for reference |
| `text` | `str` | yes | Translated text content (min 1 char) |
| `metadata` | `dict[str, JsonValue] \| None` | no | Additional structured metadata |
| `source_columns` | `list[str] \| None` | no | Original CSV column order if known |

---

## Phase I/O Schemas

Each pipeline phase has a typed input and output schema. These are used
internally by the orchestrator — the JSONL artifacts written to disk are the
*agent response* shapes described in the next section.

### Context Phase

**Input: `ContextPhaseInput`** — `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `run_id` | `RunId` | yes | Run identifier |
| `source_lines` | `list[SourceLine]` | yes | Source lines (min 1) |
| `project_context` | `str \| None` | no | High-level project context |
| `style_guide` | `str \| None` | no | Style guide content |
| `glossary` | `list[GlossaryTerm] \| None` | no | Glossary terms |

**Output: `ContextPhaseOutput`** — `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `run_id` | `RunId` | yes | Run identifier |
| `phase` | `PhaseName` | no | Always `"context"` (has constant default) |
| `project_context` | `str \| None` | no | Project context generated by the phase |
| `style_guide` | `str \| None` | no | Style guide generated by the phase |
| `glossary` | `list[GlossaryTerm] \| None` | no | Glossary generated by the phase |
| `scene_summaries` | `list[SceneSummary]` | yes | Scene summaries |
| `context_notes` | `list[ContextNote]` | yes | Context notes |

### Pretranslation Phase

**Input: `PretranslationPhaseInput`** — `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `run_id` | `RunId` | yes | Run identifier |
| `source_lines` | `list[SourceLine]` | yes | Source lines (min 1) |
| `scene_summaries` | `list[SceneSummary] \| None` | no | Context scene summaries |
| `context_notes` | `list[ContextNote] \| None` | no | Context notes |
| `project_context` | `str \| None` | no | Project context |
| `glossary` | `list[GlossaryTerm] \| None` | no | Glossary terms |

**Output: `PretranslationPhaseOutput`** — `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `run_id` | `RunId` | yes | Run identifier |
| `phase` | `PhaseName` | no | Always `"pretranslation"` (has constant default) |
| `annotations` | `list[PretranslationAnnotation]` | yes | Pretranslation annotations |
| `term_candidates` | `list[TermCandidate]` | yes | Terminology candidates |

### Translate Phase

**Input: `TranslatePhaseInput`** — `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `run_id` | `RunId` | yes | Run identifier |
| `target_language` | `LanguageCode` | yes | Target language code |
| `source_lines` | `list[SourceLine]` | yes | Source lines (min 1) |
| `scene_summaries` | `list[SceneSummary] \| None` | no | Context scene summaries |
| `context_notes` | `list[ContextNote] \| None` | no | Context notes |
| `project_context` | `str \| None` | no | Project context |
| `pretranslation_annotations` | `list[PretranslationAnnotation] \| None` | no | Pretranslation annotations |
| `term_candidates` | `list[TermCandidate] \| None` | no | Terminology candidates |
| `glossary` | `list[GlossaryTerm] \| None` | no | Glossary terms |
| `style_guide` | `str \| None` | no | Style guide content |

**Output: `TranslatePhaseOutput`** — `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `run_id` | `RunId` | yes | Run identifier |
| `phase` | `PhaseName` | no | Always `"translate"` (has constant default) |
| `target_language` | `LanguageCode` | yes | Target language code |
| `translated_lines` | `list[TranslatedLine]` | yes | Translated lines (min 1) |

### QA Phase

**Input: `QaPhaseInput`** — `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `run_id` | `RunId` | yes | Run identifier |
| `target_language` | `LanguageCode` | yes | Target language code |
| `source_lines` | `list[SourceLine]` | yes | Source lines (min 1) |
| `translated_lines` | `list[TranslatedLine]` | yes | Translated lines (min 1) |
| `scene_summaries` | `list[SceneSummary] \| None` | no | Context scene summaries |
| `context_notes` | `list[ContextNote] \| None` | no | Context notes |
| `project_context` | `str \| None` | no | Project context |
| `glossary` | `list[GlossaryTerm] \| None` | no | Glossary terms |
| `style_guide` | `str \| None` | no | Style guide content |

**Output: `QaPhaseOutput`** — `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `run_id` | `RunId` | yes | Run identifier |
| `phase` | `PhaseName` | no | Always `"qa"` (has constant default) |
| `target_language` | `LanguageCode` | yes | Target language code |
| `issues` | `list[QaIssue]` | yes | QA issues found |
| `summary` | `QaSummary` | yes | QA summary |

### Edit Phase

**Input: `EditPhaseInput`** — `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `run_id` | `RunId` | yes | Run identifier |
| `target_language` | `LanguageCode` | yes | Target language code |
| `translated_lines` | `list[TranslatedLine]` | yes | Translated lines (min 1) |
| `qa_issues` | `list[QaIssue] \| None` | no | QA issues to address |
| `reviewer_notes` | `list[ReviewerNote] \| None` | no | Reviewer notes |
| `scene_summaries` | `list[SceneSummary] \| None` | no | Context scene summaries |
| `context_notes` | `list[ContextNote] \| None` | no | Context notes |
| `project_context` | `str \| None` | no | Project context |
| `pretranslation_annotations` | `list[PretranslationAnnotation] \| None` | no | Pretranslation annotations |
| `term_candidates` | `list[TermCandidate] \| None` | no | Terminology candidates |
| `glossary` | `list[GlossaryTerm] \| None` | no | Glossary terms |
| `style_guide` | `str \| None` | no | Style guide content |

**Output: `EditPhaseOutput`** — `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `run_id` | `RunId` | yes | Run identifier |
| `phase` | `PhaseName` | no | Always `"edit"` (has constant default) |
| `target_language` | `LanguageCode` | yes | Target language code |
| `edited_lines` | `list[TranslatedLine]` | yes | Edited lines (min 1) |
| `change_log` | `list[LineEdit]` | yes | Line edit records |

---

## Agent Response Schemas

These are the structured outputs that LLM agents produce. At runtime, each
artifact is persisted as `.rentl/artifacts/{run_id}/artifact-{artifact_id}.jsonl`
and indexed in a global `.rentl/artifacts/index.jsonl`. The friendly names below
(e.g., `context.jsonl`) match the golden samples in `samples/golden/artifacts/`.

### SceneSummary

Scene-level context produced by the Context Analyzer agent.

**Module:** `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `scene_id` | `SceneId` | yes | Scene identifier |
| `summary` | `str` | yes | Scene summary (min 1 char) |
| `characters` | `list[str]` | yes | Characters appearing in the scene |

**Artifact:** `context.jsonl` — one line per scene.

```json
{"scene_id":"scene_001","summary":"Spring morning at the school gate. Transfer student Misaki meets Kenta and asks for help finding her classroom. His friend Taro joins them.","characters":["佐藤健太","美咲","田中美咲","山田太郎","???"]}
```

### IdiomAnnotation / IdiomAnnotationList

Idiom annotations produced by the Idiom Labeler agent during pretranslation.

**Module:** `rentl_schemas.phases`

**IdiomAnnotation:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `line_id` | `LineId` | yes | Line identifier for the annotation |
| `idiom_text` | `str` | yes | The idiomatic expression found |
| `explanation` | `str` | yes | Explanation of the idiom's meaning |

**IdiomAnnotationList** wraps `idioms: list[IdiomAnnotation]`.

**Artifact:** `pretranslation.jsonl` — one line per scene batch.

```json
{"idioms":[{"line_id":"scene_001_0005","idiom_text":"どきどき","explanation":"Onomatopoeia representing heartbeat or excitement, commonly used in Japanese visual novels to express nervous anticipation or romantic feelings."},{"line_id":"scene_001_0016","idiom_text":"がはは","explanation":"Onomatopoeia for a hearty, boisterous laugh, expressing Taro's friendly and outgoing personality."}]}
```

### TranslationResultLine / TranslationResultList

Translation results produced by the Translator agent.

**Module:** `rentl_schemas.phases`

**TranslationResultLine:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `line_id` | `LineId` | yes | Line identifier matching the source |
| `text` | `str` | yes | Translated text content |

**TranslationResultList** wraps `translations: list[TranslationResultLine]` (min 1).

**Artifact:** `translate.jsonl` — one line per scene batch.

```json
{"translations":[{"line_id":"scene_001_0001","text":"A spring morning at the school gate, cherry blossom petals dancing in the wind."},{"line_id":"scene_001_0002","text":"\"Um, excuse me!\""}]}
```

### StyleGuideReviewLine / StyleGuideReviewList

Per-line style guide reviews produced by the Style Guide Critic agent during QA.

**Module:** `rentl_schemas.phases`

**StyleGuideRuleViolation:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `rule_violated` | `str` | yes | Specific rule violated from the style guide |
| `explanation` | `str` | yes | Explanation of why this violates the style guide |

**StyleGuideReviewLine:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `line_id` | `LineId` | yes | Line identifier matching the source |
| `violations` | `list[StyleGuideRuleViolation]` | no | Style guide violations for this line |

**StyleGuideReviewList** wraps `reviews: list[StyleGuideReviewLine]` (min 1).

**Artifact:** `qa.jsonl` — one line per scene batch.

```json
{"reviews":[{"line_id":"scene_001_0005","violations":[{"rule_violated":"Formatting: onomatopoeia","explanation":"Onomatopoeia 'どきどき' should be formatted with asterisks or italics to distinguish it from dialogue, not left inline."}]}]}
```

### LineEdit

Record of an edit applied to a translated line.

**Module:** `rentl_schemas.qa`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `line_id` | `LineId` | yes | Line identifier |
| `original_text` | `str` | yes | Original translated text |
| `edited_text` | `str` | yes | Edited text |
| `reason` | `str \| None` | no | Reason for the edit |

**Artifact:** `edit.jsonl` — one line per edit.

```json
{"line_id":"scene_001_0005","original_text":"\"Oh, nice to meet you! I'm Misaki Tanaka, a transfer student. *My heart's pounding*","edited_text":"\"Oh, nice to meet you! I'm Misaki Tanaka, a transfer student. *Doki doki*","reason":"Changed onomatopoeia to use romanized Japanese form for consistency with VN convention"}
```

### Export Line

The export phase writes `TranslatedLine` records to `export.jsonl`, one per
script line, with full metadata attached.

**Artifact:** `export.jsonl` — one line per script line.

```json
{"line_id":"scene_001_0001","route_id":"common_0","scene_id":"scene_001","speaker":null,"source_text":"春の朝、桜の花びらが風に舞う学園の門。","text":"A spring morning at the school gate, cherry blossom petals dancing in the wind.","metadata":{"is_choice":false,"is_dialogue":false},"source_columns":null}
```

---

## QA Schemas

### QaIssue

A single QA issue discovered during validation.

**Module:** `rentl_schemas.qa`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `issue_id` | `IssueId` | yes | Unique QA issue identifier |
| `line_id` | `LineId` | yes | Line identifier associated with issue |
| `category` | `QaCategory` | yes | Issue category |
| `severity` | `QaSeverity` | yes | Issue severity |
| `message` | `str` | yes | Issue description |
| `suggestion` | `str \| None` | no | Suggested fix or remediation |
| `metadata` | `dict[str, JsonValue] \| None` | no | Additional structured metadata |

### QaSummary

Aggregate QA summary for a phase or run.

**Module:** `rentl_schemas.qa`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `total_issues` | `int` | yes | Total issue count (>= 0) |
| `by_category` | `dict[QaCategory, int]` | yes | Issue counts by category |
| `by_severity` | `dict[QaSeverity, int]` | yes | Issue counts by severity |

### ReviewerNote

Reviewer note attached to a line during QA or edit.

**Module:** `rentl_schemas.qa`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `line_id` | `LineId` | yes | Line identifier for the note |
| `note` | `str` | yes | Reviewer note text |
| `author` | `str \| None` | no | Reviewer identifier |

---

## Supporting Models

### GlossaryTerm

**Module:** `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `term` | `str` | yes | Source term |
| `translation` | `str` | yes | Preferred translation |
| `notes` | `str \| None` | no | Optional glossary notes |

### ContextNote

**Module:** `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `note_id` | `NoteId` | yes | Context note identifier |
| `line_id` | `LineId \| None` | no | Associated line identifier |
| `scene_id` | `SceneId \| None` | no | Associated scene identifier |
| `note` | `str` | yes | Context note text |

### PretranslationAnnotation

**Module:** `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `annotation_id` | `AnnotationId` | yes | Annotation identifier |
| `line_id` | `LineId` | yes | Line identifier for the annotation |
| `annotation_type` | `AnnotationType` | yes | Annotation type |
| `value` | `str \| None` | no | Annotation value if applicable |
| `notes` | `str \| None` | no | Annotation notes |
| `metadata` | `dict[str, JsonValue] \| None` | no | Structured annotation metadata |

### TermCandidate

**Module:** `rentl_schemas.phases`

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `term` | `str` | yes | Source term |
| `notes` | `str \| None` | no | Terminology notes |
| `preferred_translation` | `str \| None` | no | Preferred translation if known |

---

## Artifact Storage

At runtime, artifacts are persisted as
`.rentl/artifacts/{run_id}/artifact-{artifact_id}.{format}` and tracked by a
global index at `.rentl/artifacts/index.jsonl`. The table below shows the
logical artifact per phase (friendly names match `samples/golden/artifacts/`).

| Artifact | Schema | Granularity | Phase |
|----------|--------|-------------|-------|
| context | `SceneSummary` | 1 line per scene | context |
| pretranslation | `IdiomAnnotationList` | 1 line per scene batch | pretranslation |
| translate | `TranslationResultList` | 1 line per scene batch | translate |
| qa | `StyleGuideReviewList` | 1 line per scene batch | qa |
| edit | `LineEdit` | 1 line per edit | edit |
| export | `TranslatedLine` | 1 line per script line | export |
